{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lista de Trabajos</title>
  <link rel="stylesheet" href="{% static 'css/all_trabajos.css' %}">
  <!-- Definición de rutas para AJAX -->
</head>
<body>
  
  <!-- BARRA SUPERIOR -->
  <div class="barra-superior" style="background-color:rgb(56, 126, 67); color: white; padding: 10px 20px; display: flex; align-items: center;">
  <a href="{% url user.is_authenticated|yesno:'usuarios:dashboard,trabajo_llamkay:home' %}">
    <img src="{% static 'images/iconinicio.png' %}" alt="Logo" style="height: 40px; margin-right: 10px;">
  </a>
  <h1 style="font-size: 20px;margin: 0; font-family: 'Segoe UI', 'Roboto', sans-serif; font-style: italic; font-weight: 900;">LLAMKAY.PE</h1>

  </div>
  
  <script>
    const urlCargarProvincias = "{% url 'trabajos:ajax_cargar_provincias' %}";
    const urlCargarDistritos = "{% url 'trabajos:ajax_cargar_distritos' %}";
    const urlCargarComunidades = "{% url 'trabajos:ajax_cargar_comunidades' %}";
  </script>
  
  <!-- Scripts AJAX -->
  <script src="{% static 'trabajos/js/domProvincia.js' %}"></script>
  <script src="{% static 'trabajos/js/domDistrito.js' %}"></script>
  <script src="{% static 'trabajos/js/domComunidad.js' %}"></script>

  <!-- FORMULARIO FILTROS Y BUSCADOR -->
  <div class="filtros" style="padding: 15px;">
    <form method="GET" action="{% url 'trabajos:filtrar_trabajos' %}" style="display: flex; flex-direction: column; gap: 15px; max-width: 100%;">
      <!-- BUSCADOR -->
      <div style="display: flex; align-items: center; width: 100%;">
        <input type="text" name="buscar" placeholder="Buscar trabajo..." style="flex: 1; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px 0 0 4px; font-size: 16px;">
        <button type="submit" style="background-color:rgb(252, 245, 245); border: none; padding: 8px 12px; border-radius: 0 4px 4px 0;">
          <img src="{% static 'images/lupa.png' %}" alt="Buscar" style="height: 20px;">
        </button>
      </div>

      <!-- FILTROS Y BOTONES -->
      <div style="
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  border: 1px solid #ccc;
  padding: 10px;
  background: linear-gradient(to right, #ffffff, #d3f9d8, #ffffff);
  border-radius: 12px;">
        
        <!-- Selects -->
         
        <select name="departamento_id" id="departamento"
        style="font-weight: 900; color: black; border-radius: 10px; padding: 8px 12px; background: linear-gradient(135deg, #c3f3be, #81c784); border: 1px solid #81c784; box-shadow: 0 0 8px #81c784; font-family: Arial, sans-serif;">
        <option value="">Departamento</option>
        {% for departamento in departamentos %}
         <option value="{{ departamento.id_departamento }}">{{ departamento.nombre }}</option>
        {% endfor %}
        </select>

        <select name="provincia_id" id="provincia"
         style="font-weight: 900; color: black; border-radius: 10px; padding: 8px 12px; background: linear-gradient(135deg, #c3f3be, #81c784); border: 1px solid #81c784; box-shadow: 0 0 8px #81c784; font-family: Arial, sans-serif;">
         <option value="">Ciudad</option>
        </select>

        <select name="distrito_id" id="distrito"
       style="font-weight: 900; color: black; border-radius: 10px; padding: 8px 12px; background: linear-gradient(135deg, #c3f3be, #81c784); border: 1px solid #81c784; box-shadow: 0 0 8px #81c784; font-family: Arial, sans-serif;">
        <option value="">Distrito</option>
        </select>

        <select name="comunidad_id" id="comunidad"
        style="font-weight: 900; color: black; border-radius: 10px; padding: 8px 12px; background: linear-gradient(135deg, #c3f3be, #81c784); border: 1px solid #81c784; box-shadow: 0 0 8px #81c784; font-family: Arial, sans-serif;">
        <option value="">Comunidad</option>
        </select>

        <!-- Botones tipo chip -->
        <div>
        <button type="button" class="tipo-btn" onclick="toggleTipo(this)" data-tipo="empresa" style="
    background: linear-gradient(to right, #064e3b, #065f46);
    color: white;
    font-weight: bold;
    border: 2px solid #06b6d4;
    border-radius: 10px;
    padding: 8px 16px;
    font-family: 'Segoe UI', sans-serif;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 0 8px #10b981;
  ">Empresas</button>

        <button type="button" class="tipo-btn" onclick="toggleTipo(this)" data-tipo="empleador" style="
    background: linear-gradient(to right, #064e3b, #065f46);
    color: white;
    font-weight: bold;
    border: 2px solid #06b6d4;
    border-radius: 10px;
    padding: 8px 16px;
    font-family: 'Segoe UI', sans-serif;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 0 8px #10b981;
  ">Empleadores</button>
        </div>

        


        <input type="hidden" name="tipo_usuario" id="tipoUsuarioInput">
        <button type="submit" style="
  background: linear-gradient(135deg, #00d2ff, #0077ff);
  color: white;
  font-weight: 800;
  font-family: 'Segoe UI', 'Roboto', sans-serif;
  padding: 10px 20px;
  border: none;
  border-radius: 12px;
  box-shadow: 0 0 12px rgba(0, 162, 255, 0.6);
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
">
  Filtrar
        </button>

      </div>
    </form>
  </div>

  <!-- CONTENEDOR PRINCIPAL: tarjetas resumidas -->
  <div class="container">
    <div class="trabajos-grid">
      {% for trabajo in trabajos %}
        <div class="tarjeta-trabajo" data-id="{{ trabajo.id }}">
          <!-- Icono Guardar -->
          <div class="iconos-tarjeta">
            {% with id_str=trabajo.tipo|add:"_"|add:trabajo.id|stringformat:"s" %}
              {% if id_str in trabajos_guardados_ids %}
                <img src="{% static 'images/guardar.png' %}" alt="Guardado" class="guardar-icon" title="Ya guardado">
              {% else %}
                <a href="{% url 'trabajos:guardar_trabajo' trabajo.tipo trabajo.id %}" title="Guardar">
                  <img src="{% static 'images/guardar1.png' %}" alt="Guardar" class="guardar-icon">
                </a>
              {% endif %}
            {% endwith %}
          </div>
          <!-- Info resumida -->
          <p class="publicado-por">Publicado por: {{ trabajo.publicado_por }}</p>
          <h3 class="titulo-trabajo">{{ trabajo.titulo }}</h3>
          <p class="fecha-publicacion">Publicado: 
            {{ trabajo.fecha_registro.day }} de 
            {% if trabajo.fecha_registro.month == 1 %}enero
            {% elif trabajo.fecha_registro.month == 2 %}febrero
            {% elif trabajo.fecha_registro.month == 3 %}marzo
            {% elif trabajo.fecha_registro.month == 4 %}abril
            {% elif trabajo.fecha_registro.month == 5 %}mayo
            {% elif trabajo.fecha_registro.month == 6 %}junio
            {% elif trabajo.fecha_registro.month == 7 %}julio
            {% elif trabajo.fecha_registro.month == 8 %}agosto
            {% elif trabajo.fecha_registro.month == 9 %}septiembre
            {% elif trabajo.fecha_registro.month == 10 %}octubre
            {% elif trabajo.fecha_registro.month == 11 %}noviembre
            {% elif trabajo.fecha_registro.month == 12 %}diciembre
            {% endif %} de {{ trabajo.fecha_registro.year }}
          </p>
          {% if trabajo.foto %}
            <div class="contenedor-imagen">
              <img src="{{ trabajo.foto.url }}" alt="{{ trabajo.titulo }}" class="imagen-trabajo" />
            </div>
          {% endif %}
          <p class="direccion">
          <img src="{% static 'images/ubicacion.png' %}" alt="Dirección" class="icono-direccion">
          {% if trabajo.id_departamento %}{{ trabajo.id_departamento.nombre }}, {% endif %}
          {% if trabajo.id_provincia %}{{ trabajo.id_provincia.nombre }}, {% endif %}
          {% if trabajo.id_distrito %}{{ trabajo.id_distrito.nombre }}, {% endif %}
           {% if trabajo.id_comunidad %}{{ trabajo.id_comunidad.nombre }}{% endif %}
          </p>

          <p><strong>Fecha Límite:</strong> 
            {{ trabajo.fecha_limite.day }} de 
            {% if trabajo.fecha_limite.month == 1 %}enero
            {% elif trabajo.fecha_limite.month == 2 %}febrero
            {% elif trabajo.fecha_limite.month == 3 %}marzo
            {% elif trabajo.fecha_limite.month == 4 %}abril
            {% elif trabajo.fecha_limite.month == 5 %}mayo
            {% elif trabajo.fecha_limite.month == 6 %}junio
            {% elif trabajo.fecha_limite.month == 7 %}julio
            {% elif trabajo.fecha_limite.month == 8 %}agosto
            {% elif trabajo.fecha_limite.month == 9 %}septiembre
            {% elif trabajo.fecha_limite.month == 10 %}octubre
            {% elif trabajo.fecha_limite.month == 11 %}noviembre
            {% elif trabajo.fecha_limite.month == 12 %}diciembre
            {% endif %} de {{ trabajo.fecha_limite.year }}
            {% if trabajo.horas_limite %} a las {{ trabajo.horas_limite }}{% endif %}
          </p>

          <!-- Botones -->
          <div class="contenedor-contacto-mensaje">
            {% if trabajo.numero_contacto %}
              <a href="https://wa.me/{{ trabajo.numero_contacto }}?text=Hola%2C%20estoy%20interesado%20en%20la%20oferta%20de%20trabajo%3A%20{{ trabajo.titulo|urlencode }}" target="_blank" class="boton-contactar">
                📱 Contactar 
              </a>
            {% else %}
              <span class="boton-contactar-deshabilitado" title="Sin número de contacto disponible">
                📱 Sin contacto
              </span>
            {% endif %}
            <img src="{% static 'images/comentario.png' %}" alt="Mensajería" class="mensaje-icon-btn" title="Mensaje">
            <button class="ver-mas-btn" onclick="abrirModal('{{ trabajo.id }}-{{ trabajo.tipo }}')">Ver más</button>
          </div>
        </div>
      {% empty %}
        <p>No hay trabajos disponibles.</p>
      {% endfor %}
       </div>
      </div>
 
      <!-- Modal flotante con toda la información -->
      {# ——— AHORA LOS MODALES FUERA DEL GRID ——— #}
  {% for trabajo in trabajos %}
  <div id="modal-{{ trabajo.id }}-{{ trabajo.tipo }}" class="modal-trabajo">
    <div class="modal-contenido">
      <span class="cerrar-modal" onclick="cerrarModal('{{ trabajo.id }}-{{ trabajo.tipo }}')">&times;</span>

      <h2>{{ trabajo.titulo }}</h2>

      {% if trabajo.foto %}
        <img src="{{ trabajo.foto.url }}" class="imagen-trabajo" alt="imagen completa">
      {% endif %}

      <p><strong>Publicado por:</strong> {{ trabajo.publicado_por }}</p>
      <p><strong>Publicado:</strong> 
        {{ trabajo.fecha_registro.day }} de 
        {% if trabajo.fecha_registro.month == 1 %}enero
        {% elif trabajo.fecha_registro.month == 2 %}febrero
        {% elif trabajo.fecha_registro.month == 3 %}marzo
        {% elif trabajo.fecha_registro.month == 4 %}abril
        {% elif trabajo.fecha_registro.month == 5 %}mayo
        {% elif trabajo.fecha_registro.month == 6 %}junio
        {% elif trabajo.fecha_registro.month == 7 %}julio
        {% elif trabajo.fecha_registro.month == 8 %}agosto
        {% elif trabajo.fecha_registro.month == 9 %}septiembre
        {% elif trabajo.fecha_registro.month == 10 %}octubre
        {% elif trabajo.fecha_registro.month == 11 %}noviembre
        {% elif trabajo.fecha_registro.month == 12 %}diciembre
        {% endif %} de {{ trabajo.fecha_registro.year }}
      </p>

      {% if trabajo.descripcion %}
        <p><strong>Descripción:</strong><br>{{ trabajo.descripcion }}</p>
      {% endif %}

      {# ==== CAMPOS SEGÚN TIPO ==== #}
      {% if trabajo.tipo == 'usuario' %}

        {% if trabajo.herramientas %}<p><strong>Herramientas:</strong><br>{{ trabajo.herramientas }}</p>{% endif %}
      {% elif trabajo.tipo == "empresa" %}
        {% if trabajo.experiencia_requerida %}<p><strong>Experiencia:</strong> {{ trabajo.experiencia_requerida }}</p>{% endif %}
        {% if trabajo.modalidad_trabajo %}<p><strong>Modalidad:</strong> {{ trabajo.modalidad_trabajo }}</p>{% endif %}
        {% if trabajo.requisitos_calificaciones %}<p><strong>Requisitos:</strong> {{ trabajo.requisitos_calificaciones }}</p>{% endif %}
        {% if trabajo.beneficios_compensaciones %}<p><strong>Beneficios:</strong> {{ trabajo.beneficios_compensaciones }}</p>{% endif %}
      {% endif %}

      {# ==== DIRECCIÓN ==== #}
      <p><strong>Dirección:</strong>
        {% if trabajo.id_departamento %}{{ trabajo.id_departamento.nombre }}, {% endif %}
        {% if trabajo.id_provincia %}{{ trabajo.id_provincia.nombre }}, {% endif %}
        {% if trabajo.id_distrito %}{{ trabajo.id_distrito.nombre }}, {% endif %}
        {% if trabajo.id_comunidad %}{{ trabajo.id_comunidad.nombre }}{% endif %}
      </p>

      {# ==== PAGO O RANGO SALARIAL ==== #}
      {% if trabajo.pago %}
        <p><strong>Pago:</strong> S/ {{ trabajo.pago }}</p>
      {% elif trabajo.rango_salarial %}
        <p><strong>Rango Salarial:</strong> {{ trabajo.rango_salarial }}</p>
      {% endif %}

      <p><strong>Fecha Límite:</strong> 
        {{ trabajo.fecha_limite.day }} de 
        {% if trabajo.fecha_limite.month == 1 %}enero
        {% elif trabajo.fecha_limite.month == 2 %}febrero
        {% elif trabajo.fecha_limite.month == 3 %}marzo
        {% elif trabajo.fecha_limite.month == 4 %}abril
        {% elif trabajo.fecha_limite.month == 5 %}mayo
        {% elif trabajo.fecha_limite.month == 6 %}junio
        {% elif trabajo.fecha_limite.month == 7 %}julio
        {% elif trabajo.fecha_limite.month == 8 %}agosto
        {% elif trabajo.fecha_limite.month == 9 %}septiembre
        {% elif trabajo.fecha_limite.month == 10 %}octubre
        {% elif trabajo.fecha_limite.month == 11 %}noviembre
        {% elif trabajo.fecha_limite.month == 12 %}diciembre
        {% endif %} de {{ trabajo.fecha_limite.year }}
        {% if trabajo.horas_limite %} a las {{ trabajo.horas_limite }}{% endif %}
      </p>

      {# ==== POSTULANTES (solo empresa) ==== #}
      {% if trabajo.numero_postulantes %}
        <p><strong>Postulantes:</strong> {{ trabajo.numero_postulantes }}</p>
      {% endif %}
      </div>
    </div>
  {% endfor %}



  <!-- SCRIPT PARA LOS BOTONES -->
  <script>
    function toggleTipo(btn) {
      document.querySelectorAll('.tipo-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      
      // Usar el atributo data-tipo para mayor precisión
      const valor = btn.getAttribute('data-tipo') || '';
      
      document.getElementById('tipoUsuarioInput').value = valor;
      console.log('Filtro seleccionado:', btn.textContent.trim(), '→', valor);
    }

    // Funcionalidad de "guardar" usando localStorage
    document.addEventListener('DOMContentLoaded', function() {
      const savedKey = 'trabajosGuardados';
      let guardados = [];
      try {
        const stored = localStorage.getItem(savedKey);
        if (stored) {
          guardados = JSON.parse(stored);
        }
      } catch(e) {
        guardados = [];
      }
      document.querySelectorAll('.tarjeta-trabajo').forEach(card => {
        const id = card.dataset.id;
        const icon = card.querySelector('.guardar-icon');
        if (id && icon) {
          if (guardados.includes(id)) {
            icon.classList.add('saved');
          }
          icon.addEventListener('click', function(evt) {
            evt.stopPropagation();
            const idx = guardados.indexOf(id);
            if (idx === -1) {
              guardados.push(id);
              icon.classList.add('saved');
            } else {
              guardados.splice(idx, 1);
              icon.classList.remove('saved');
            }
            localStorage.setItem(savedKey, JSON.stringify(guardados));
          });
        }
      });

      // Evento para íconos de mensajería (separados)
      document.querySelectorAll('.mensaje-icon-btn').forEach(img => {
        img.addEventListener('click', function(evt) {
          evt.stopPropagation();
          alert('Funcionalidad de mensajería aún no implementada.');
        });
      });
    });
  </script>
<style>
      .tipo-btn.selected {
        background: linear-gradient(to right, #b45309, #7c2d12) !important;
        box-shadow: 0 0 10px #f97316;
        border-color: #f59e0b;
        transform: scale(1.05);
      }
      
      .tipo-btn {
        transition: all 0.3s ease;
      }
      </style>
  <script>
function abrirModal(id) {
  document.getElementById('modal-' + id).classList.add('mostrar');
}
function cerrarModal(id) {
  document.getElementById('modal-' + id).classList.remove('mostrar');
}
window.addEventListener('click', function(e) {
  document.querySelectorAll('.modal-trabajo.mostrar').forEach(modal => {
    if (e.target === modal) modal.classList.remove('mostrar');
  });
});
</script>
  <style>
    
    .modal-trabajo {
  display: none;
  position: fixed;            /* Fijo al viewport */
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.6); /* Fondo semitransparente */
  z-index: 9999;              /* Por encima de todo */
  overflow: auto;             /* Scroll si es necesario */
}

.modal-trabajo.mostrar {
  display: block;
}

/* Contenedor interno centrado y flotante */
.modal-trabajo .modal-contenido {
  background-color: #fff;
  max-width: 600px;
  margin: 60px auto;          /* Centrado vertical y horizontal */
  padding: 20px;
  border-radius: 15px;
  box-shadow: 0 0 15px rgba(0, 255, 128, 0.7);
  animation: aparecer 0.3s ease-in-out;
  position: relative;
}

/* Botón cerrar */
.modal-trabajo .cerrar-modal {
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 24px;
  font-weight: bold;
  cursor: pointer;
  color: #222;
}

/* Imagen dentro del modal */
.modal-trabajo .imagen-trabajo {
  width: 100%;
  max-height: 200px;
  object-fit: cover;
  border-radius: 8px;
  margin-bottom: 15px;
}

/* Contenedor de imagen en tarjetas */
.contenedor-imagen {
  width: 100%;
  height: 200px;
  overflow: hidden;
  border-radius: 12px;
  margin: 15px 0;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  position: relative;
}

/* Imagen en tarjetas mejorada */
.tarjeta-trabajo .imagen-trabajo {
  width: 100%;
  height: 100%;
  object-fit: cover;
  object-position: center;
  transition: transform 0.3s ease;
  border-radius: 12px;
}

.contenedor-imagen:hover .imagen-trabajo {
  transform: scale(1.05);
}

/* Mejoras en las tarjetas */
.tarjeta-trabajo {
  background: white;
  border-radius: 15px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.tarjeta-trabajo:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

/* Título del trabajo más prominente */
.titulo-trabajo {
  color: #2e7d32;
  font-size: 1.3rem;
  font-weight: 900;
  margin: 10px 0;
  line-height: 1.3;
}

/* Fecha de publicación mejorada */
.fecha-publicacion {
  color: #666;
  font-size: 0.9rem;
  font-style: italic;
  margin-bottom: 15px;
}

/* Publicado por mejorado */
.publicado-por {
  color: #000000;
  font-weight: 700;
  font-size: 0.95rem;
  margin-bottom: 8px;
}

/* Animación de aparición */
@keyframes aparecer {
  from {
    transform: scale(0.9);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}

/* Botón “Ver más” dentro de la tarjeta */
.ver-mas-btn {
  background: #198754;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  margin-left: auto;
  transition: background-color 0.3s ease;
}
.ver-mas-btn:hover {
  background-color: #145f3a;
}
.icono-direccion {
  width: 20px;
  height: 20px;
  vertical-align: middle;
  margin-right: 0px;
  filter: drop-shadow(0 0 0 rgba(0, 0, 0, 0.4));
}

  </style>


</body>
</html>
