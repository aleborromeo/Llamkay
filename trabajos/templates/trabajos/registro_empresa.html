{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Oferta Laboral</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/registro_empresa.css' %}" />
</head>
<body class="fondo">
  <div class="seccion-container">
    <div class="form-container">
      <a href="{% url 'trabajos:admin_empresa' %}" class="btn-volver">
        <i class="fas fa-arrow-left"></i> Volver
      </a>

      <h2 class="titulo-principal">ðŸ’¼ Oferta Laboral</h2>
      <p class="descripcion">Detalles del puesto disponible para primer trabajo</p>

      <div class="formulario">
        <form enctype="multipart/form-data" method="POST" onsubmit="return validarUbicacion();">
          {% csrf_token %}
          {{ form.non_field_errors }}

          <div class="fila">
            <div class="campo">
              {{ form.titulo_puesto.label_tag }}
              {{ form.titulo_puesto }}
            </div>
            <div class="campo">
              {{ form.rango_salarial.label_tag }}
              {{ form.rango_salarial }}
            </div>
          </div>

          <div class="fila">
            <div class="campo">
              {{ form.experiencia_requerida.label_tag }}
              {{ form.experiencia_requerida }}
            </div>
            <div class="campo">
              {{ form.modalidad_trabajo.label_tag }}
              {{ form.modalidad_trabajo }}
            </div>
          </div>

          <div class="campo">
            {{ form.descripcion_puesto.label_tag }}
            {{ form.descripcion_puesto }}
          </div>

          <div class="campo">
            {{ form.requisitos_calificaciones.label_tag }}
            {{ form.requisitos_calificaciones }}
          </div>

          <div class="campo">
            {{ form.beneficios_compensaciones.label_tag }}
            {{ form.beneficios_compensaciones }}
          </div>

          <div class="fila">
            <div class="campo">
              {{ form.fecha_limite.label_tag }}
              {{ form.fecha_limite }}
            </div>
            <div class="campo">
              {{ form.numero_postulantes.label_tag }}
              {{ form.numero_postulantes }}
            </div>
          </div>

          <div class="direccion">
            <div class="campo">
              <label>Departamento</label>
              {{ form.id_departamento }}
            </div>
            
            <div class="campo">
              <label>Provincia</label>
              {{ form.id_provincia }}
            </div>

            <div class="campo">
              <label>Distrito</label>
              {{ form.id_distrito }}
            </div>

            <div class="campo">
              <label>Comunidad</label>
              {{ form.id_comunidad }}
            </div>

            <div class="campo direccion-detalle">
              <label>DirecciÃ³n Detalle</label>
              {{ form.direccion_detalle }}
            </div>
          </div>

          <div class="campo">
            {{ form.foto.label_tag }}
            {{ form.foto }}
            <img id="preview" class="image-preview" style="display:none" />
          </div>

          <div class="form-buttons">
            {% if modo_edicion %}
              <button type="submit" class="btn-editar">
                <i class="fas fa-save"></i> Guardar Cambios
              </button>
              <a href="{% url 'trabajos:all_trabajos' %}" class="btn-cancelar">
                <i class="fas fa-times"></i> Cancelar
              </a>
            {% else %}
              <button type="submit" class="btn-registrar">
                <i class="fas fa-upload"></i> Publicar Oferta
              </button>
              <a href="{% url 'trabajos:admin_empresa' %}" class="btn-cancelar">
                <i class="fas fa-times"></i> Cancelar
              </a>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    function validarUbicacion() {
      const dpto = document.getElementById('id_id_departamento').value;
      const prov = document.getElementById('id_id_provincia').value;
      const dist = document.getElementById('id_id_distrito').value;
      const comu = document.getElementById('id_id_comunidad').value;
      if (!dpto && !prov && !dist && !comu) {
        alert("Debe completar al menos uno de los campos de ubicaciÃ³n.");
        return false;
      }
      return true;
    }

    function previewImage(event) {
      const preview = document.getElementById('preview');
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.src = e.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        preview.style.display = 'none';
        preview.src = '';
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      const departamentoSelect = document.getElementById('id_id_departamento');
      const provinciaSelect = document.getElementById('id_id_provincia');
      const distritoSelect = document.getElementById('id_id_distrito');
      const comunidadSelect = document.getElementById('id_id_comunidad');

      if (departamentoSelect) {
        departamentoSelect.addEventListener('change', function () {
          const departamentoId = this.value;
          fetch(`/trabajos/ajax/cargar-provincias/?departamento_id=${departamentoId}`)
            .then(response => response.json())
            .then(data => {
              provinciaSelect.innerHTML = '<option value="">Seleccione</option>';
              data.forEach(function (provincia) {
                provinciaSelect.innerHTML += `<option value="${provincia.id_provincia}">${provincia.nombre}</option>`;
              });
              distritoSelect.innerHTML = '<option value="">Seleccione</option>';
              comunidadSelect.innerHTML = '<option value="">Seleccione</option>';
            });
        });

        provinciaSelect.addEventListener('change', function () {
          const provinciaId = this.value;
          fetch(`/trabajos/ajax/cargar-distritos/?provincia_id=${provinciaId}`)
            .then(response => response.json())
            .then(data => {
              distritoSelect.innerHTML = '<option value="">Seleccione</option>';
              data.forEach(function (distrito) {
                distritoSelect.innerHTML += `<option value="${distrito.id_distrito}">${distrito.nombre}</option>`;
              });
              comunidadSelect.innerHTML = '<option value="">Seleccione</option>';
            });
        });

        distritoSelect.addEventListener('change', function () {
          const distritoId = this.value;
          fetch(`/trabajos/ajax/cargar-comunidades/?distrito_id=${distritoId}`)
            .then(response => response.json())
            .then(data => {
              comunidadSelect.innerHTML = '<option value="">Seleccione</option>';
              data.forEach(function (comunidad) {
                comunidadSelect.innerHTML += `<option value="${comunidad.id_comunidad}">${comunidad.nombre}</option>`;
              });
            });
        });

        const fotoInput = document.getElementById('id_foto');
        if (fotoInput) {
          fotoInput.addEventListener('change', previewImage);
        }
      }
    });
  </script>
</body>
</html>
